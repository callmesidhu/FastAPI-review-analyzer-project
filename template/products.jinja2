<!DOCTYPE html>
<html>
<head>
  <title>Products - Amazon Review Analysis</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header class="animated-header">
      <h1>Analyzed Products</h1>
    </header>

    <nav class="nav-bar">
      <a href="/" class="nav-btn">
        <span class="nav-icon">Home</span>
      </a>
      <a href="/products" class="nav-btn active">
        <span class="nav-icon">Products</span>
      </a>
      <a href="/dashboard" class="nav-btn">
        <span class="nav-icon">Dashboard</span>
      </a>
      <a href="/clear" class="nav-btn clear-btn">
        <span class="nav-icon">Clear Data</span>
      </a>
    </nav>

    <div class="main-content">
      {% if products %}
        <div class="products-grid animated-products">
          {% for product in products %}
            <div class="product-card" data-product-id="{{ product.product_id }}">
              <div class="product-image">
                {% if product.product_image %}
                  <img src="{{ product.product_image }}" alt="{{ product.product_name }}" loading="lazy">
                {% else %}
                  <div class="no-image">No Image Available</div>
                {% endif %}
              </div>
              <div class="product-info">
                <h3>{{ product.product_name }}</h3>
                <div class="product-price">{{ product.product_price }}</div>
                <div class="product-stats">
                  <span class="review-count">{{ product.review_count }} Reviews Analyzed</span>
                </div>
                <div class="product-actions">
                  <a href="{{ product.product_url }}" target="_blank" class="btn-secondary">
                    <span></span> View on Amazon
                  </a>
                  <!-- Open Modal Button -->
                  <button class="btn-secondary review-toggle" onclick="openReviewsModal('{{ product.product_id }}', '{{ product.product_name|escape }}')">
                    <span></span> Show Reviews
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state animated-empty">
          <div class="empty-icon">No Products</div>
          <h2>No Products Analyzed Yet</h2>
          <p>Start by analyzing your first Amazon product to see detailed insights and customer sentiment data!</p>
          <a href="/" class="btn-primary">
            <span></span> Start Analysis
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Review Modal Structure -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modalProductTitle">Product Reviews</h4>
                <button class="close-modal" onclick="closeReviewsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalLoading" class="reviews-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading reviews...</p>
                </div>
                <div id="modalReviewsList"></div>
            </div>
        </div>
    </div>

  </div>

  <script>
    // Animation on page load
    document.addEventListener('DOMContentLoaded', function() {
      // (Existing animation code remains same)
      const header = document.querySelector('.animated-header');
      const products = document.querySelectorAll('.product-card');
      const emptyState = document.querySelector('.animated-empty');
      
      if (header) {
        header.style.transform = 'translateY(-30px)';
        header.style.opacity = '0';
        setTimeout(() => {
            header.style.transition = 'all 0.6s ease';
            header.style.transform = 'translateY(0)';
            header.style.opacity = '1';
        }, 100);
      }
      
      products.forEach((card, index) => {
        card.style.transform = 'translateY(30px)';
        card.style.opacity = '0';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.transform = 'translateY(0)';
            card.style.opacity = '1';
        }, 200 + (index * 100));
      });
      
      if (emptyState) {
        emptyState.style.transform = 'scale(0.8)';
        emptyState.style.opacity = '0';
        setTimeout(() => {
            emptyState.style.transition = 'all 0.6s ease';
            emptyState.style.transform = 'scale(1)';
            emptyState.style.opacity = '1';
        }, 300);
      }
    });

    // --- Modal Logic ---

    async function openReviewsModal(productId, productName) {
        const modal = document.getElementById('reviewModal');
        const modalTitle = document.getElementById('modalProductTitle');
        const modalLoading = document.getElementById('modalLoading');
        const modalList = document.getElementById('modalReviewsList');

        // Set content
        modalTitle.textContent = productName;
        modalList.innerHTML = ''; // Clear previous
        modalLoading.style.display = 'block';

        // Show Modal
        modal.style.display = 'flex';

        // Fetch Data
        try {
            const response = await fetch(`/api/product-reviews/${productId}`);
            if (!response.ok) throw new Error("Failed to fetch reviews");
            
            const reviews = await response.json();
            modalLoading.style.display = 'none';

            if (reviews.length === 0) {
                modalList.innerHTML = '<p class="no-reviews">No reviews found for this product.</p>';
                return;
            }

            modalList.innerHTML = reviews.map(review => `
              <div class="review-item">
                <div class="review-header">
                  <h5>${review.review_title || 'Customer Review'}</h5>
                  <div class="review-rating">
                    ${'â˜…'.repeat(Math.ceil(review.rating || 0))}
                    <span class="rating-text">(${review.rating || 0}/5)</span>
                  </div>
                </div>
                <p class="review-text">${review.review_text || 'No review content available.'}</p>
                <div class="review-meta">
                  <span class="sentiment sentiment-${(review.sentiment || 'neutral').toLowerCase()}">
                    ${review.sentiment === 'positive' ? 'Positive' : 
                      review.sentiment === 'negative' ? 'Negative' : 'Neutral'}
                  </span>
                  <span class="confidence">Confidence: ${Math.round((review.polarity || 0) * 100)}%</span>
                </div>
              </div>
            `).join('');

        } catch (error) {
            console.error(error);
            modalLoading.style.display = 'none';
            modalList.innerHTML = `<p class="error-message">Error loading reviews: ${error.message}</p>`;
        }
    }

    function closeReviewsModal() {
        const modal = document.getElementById('reviewModal');
        modal.style.display = 'none';
    }

    // Close on click outside
    window.onclick = function(event) {
        const modal = document.getElementById('reviewModal');
        if (event.target == modal) {
            closeReviewsModal();
        }
    }
  </script>
</body>
</html>